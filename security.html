// security.js - основные функции защиты

class SecuritySystem {
    constructor() {
        this.attempts = 0;
        this.maxAttempts = 5;
        this.lockoutTime = 300000; // 5 минут
        this.init();
    }
    
    // Инициализация системы безопасности
    init() {
        this.checkEnvironment();
        this.setupProtections();
    }
    
    // Проверка окружения
    checkEnvironment() {
        const features = {
            cookies: navigator.cookieEnabled,
            localStorage: !!window.localStorage,
            sessionStorage: !!window.sessionStorage,
            workers: !!window.Worker,
            geolocation: !!navigator.geolocation
        };
        
        const allSupported = Object.values(features).every(f => f === true);
        
        if (!allSupported) {
            console.warn('Некоторые функции безопасности недоступны в этом браузере');
        }
        
        return allSupported;
    }
    
    // Настройка базовых защит
    setupProtections() {
        // Защита от iframe (clickjacking)
        if (window.top !== window.self) {
            window.top.location = window.self.location;
        }
        
        // Базовая защита от копирования
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) e.preventDefault();
        });
    }
    
    // Проверка браузера
    checkBrowser() {
        return this.checkEnvironment();
    }
    
    // Защита от brute force
    checkAttempts() {
        const attempts = parseInt(localStorage.getItem('loginAttempts') || '0');
        const lastAttempt = parseInt(localStorage.getItem('lastAttempt') || '0');
        const now = Date.now();
        
        if (attempts >= this.maxAttempts && now - lastAttempt < this.lockoutTime) {
            const remaining = Math.ceil((this.lockoutTime - (now - lastAttempt)) / 1000);
            throw new Error(`Слишком много попыток. Попробуйте через ${remaining} секунд.`);
        }
        
        return attempts;
    }
    
    // Запись попытки
    recordAttempt(success) {
        let attempts = parseInt(localStorage.getItem('loginAttempts') || '0');
        
        if (success) {
            attempts = 0;
        } else {
            attempts++;
        }
        
        localStorage.setItem('loginAttempts', attempts.toString());
        localStorage.setItem('lastAttempt', Date.now().toString());
        
        return attempts;
    }
    
    // Очистка чувствительных данных
    clearSensitiveData() {
        const sensitiveKeys = ['userToken', 'authData', 'sessionKey', 'loginAttempts', 'lastAttempt'];
        sensitiveKeys.forEach(key => {
            localStorage.removeItem(key);
            sessionStorage.removeItem(key);
        });
    }
    
    // Шифрование данных
    encryptData(data, key) {
        try {
            return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
        } catch (error) {
            console.error('Ошибка шифрования:', error);
            return null;
        }
    }
    
    // Дешифрование данных
    decryptData(encryptedData, key) {
        try {
            const bytes = CryptoJS.AES.decrypt(encryptedData, key);
            return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        } catch (error) {
            console.error('Ошибка дешифрования:', error);
            return null;
        }
    }
    
    // Генерация соли для хеширования
    generateSalt(length = 16) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let salt = '';
        for (let i = 0; i < length; i++) {
            salt += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return salt;
    }
    
    // Хеширование пароля
    hashPassword(password, salt) {
        try {
            return CryptoJS.SHA256(password + salt).toString();
        } catch (error) {
            console.error('Ошибка хеширования:', error);
            return null;
        }
    }
}

// Создаем глобальный экземпляр системы безопасности
window.securitySystem = new SecuritySystem();

// Honey tokens - приманки для хакеров
const honeyTokens = {
    fakeAdmin: {
        username: 'superadmin',
        password: 'admin123',
        email: 'admin@example.com'
    },
    fakeApi: {
        url: '/api/v1/internal/auth',
        key: 'fake-internal-key-12345'
    }
};

// Настройка ловушек
function setupHoneypots() {
    // Защита с помощью Proxy для отслеживания доступа
    const honeyHandler = {
        get: function(target, property) {
            console.warn('Доступ к honey token:', property);
            // В реальной системе здесь должна быть отправка уведомления
            return target[property];
        }
    };
    
    window.honeyProxy = new Proxy(honeyTokens, honeyHandler);
}

// Запуск защиты при полной загрузке страницы
window.addEventListener('load', function() {
    setupHoneypots();
    console.log('Система безопасности инициализирована');
});
